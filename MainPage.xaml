<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ArborChat.MainPage"
             xmlns:vm="clr-namespace:ArborChat.ViewModels"
             xmlns:converters="clr-namespace:ArborChat.Converters"
             x:DataType="vm:MainViewModel"
             Title="ArborChat">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsAiMessageConverter x:Key="IsAiMessageConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="MainGrid" RowDefinitions="*">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition x:Name="ThreadColumn" Width="0" />
        </Grid.ColumnDefinitions>
        <Grid.Triggers>
            <DataTrigger TargetType="Grid"
                         Binding="{Binding IsThreadPanelVisible}"
                         Value="True">
                <Setter TargetName="ThreadColumn" Property="Width" Value="300" />
            </DataTrigger>
        </Grid.Triggers>
        <!-- Left Sidebar (Chat Sessions) -->
        <Border Grid.Column="0" BackgroundColor="#282828">
            <VerticalStackLayout Spacing="5" Padding="5">
                <Button Text="New Chat" Command="{Binding NewChatCommand}" />
                <ScrollView VerticalOptions="FillAndExpand">
                    <CollectionView ItemsSource="{Binding ChatSessions}"
                                    SelectedItem="{Binding SelectedChatSession}"
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#333333" BorderColor="#555555" CornerRadius="5" Margin="2" Padding="5">
                                    <Label Text="{Binding Title}" TextColor="White" FontSize="Medium" />
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </ScrollView>
                <Button Text="Settings"
                        VerticalOptions="EndAndExpand"
                        Margin="10"
                        Clicked="OnSettingsClicked" />
            </VerticalStackLayout>
        </Border>

        <!-- Main Chat Area -->
        <Grid Grid.Column="1" RowDefinitions="*, Auto">
            <!-- Loading Indicator -->
            <ActivityIndicator Grid.Row="0"
                               IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               Color="{StaticResource Accent}"
                               VerticalOptions="Center"
                               HorizontalOptions="Center" />

            <!-- Message Display -->
            <CollectionView x:Name="MainChatCollectionView" Grid.Row="0" Margin="10" ItemsSource="{Binding CurrentChatMessages}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame HasShadow="True" CornerRadius="10" Margin="5" Padding="10">
                            <VerticalStackLayout>
                                <Label Text="{Binding Role}" FontAttributes="Bold" />
                                <Label Text="{Binding Content}" />
                                <Button Text="Start Thread"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=StartThreadCommand}"
                                        CommandParameter="{Binding .}"
                                        IsVisible="{Binding Role, Converter={StaticResource IsAiMessageConverter}}"
                                        HorizontalOptions="End"
                                        Margin="0,5,0,0" />
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Message Input -->
            <Grid Grid.Row="1" ColumnDefinitions="*, Auto" Padding="10">
                <Editor x:Name="MessageEditor" Grid.Column="0" Placeholder="Type your message..." Text="{Binding NewMessageText}" />
                <Button x:Name="SendButton" Grid.Column="1" Text="Send" Command="{Binding SendMessageCommand}" />
            </Grid>
        </Grid>

        <!-- Right Thread Panel -->
        <Border Grid.Column="2" BackgroundColor="#282828">
            <VerticalStackLayout>
                <Grid ColumnDefinitions="*, Auto">
                    <Label Grid.Column="0" Text="Thread Panel" TextColor="White" FontSize="Title" HorizontalOptions="Center" VerticalOptions="Center" />
                    <Button Grid.Column="1" Text="X" Command="{Binding CloseThreadCommand}" WidthRequest="40" HeightRequest="40" HorizontalOptions="End" />
                </Grid>
                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="{StaticResource Accent}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center" />
                <CollectionView x:Name="ThreadChatCollectionView" Margin="10" ItemsSource="{Binding CurrentThreadMessages}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame HasShadow="True" CornerRadius="10" Margin="5" Padding="10">
                                <VerticalStackLayout>
                                    <Label Text="{Binding Role}" FontAttributes="Bold" />
                                    <Label Text="{Binding Content}" />
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <Grid VerticalOptions="End" ColumnDefinitions="*, Auto" Padding="10">
                    <Editor Grid.Column="0" Placeholder="Type your thread message..." Text="{Binding NewThreadMessageText}" />
                    <Button Grid.Column="1" Text="Send" Command="{Binding SendThreadMessageCommand}" />
                </Grid>
            </VerticalStackLayout>
        </Border>    </Grid>

</ContentPage>
